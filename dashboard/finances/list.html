<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manajemen Keuangan - Dashboard KARTEJI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="stylesheet" href="/assets/css/responsive.css">
</head>
<body>
  <div id="sidebar"></div>

  <div class="main-content">
    <h1 class="text-3xl font-bold mb-6">Manajemen Keuangan</h1>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold mb-2">Total Pemasukan</h3>
        <p id="total-income" class="text-3xl font-bold">Rp 0</p>
      </div>

      <div class="bg-gradient-to-br from-red-500 to-red-600 text-white p-6 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold mb-2">Total Pengeluaran</h3>
        <p id="total-expense" class="text-3xl font-bold">Rp 0</p>
      </div>

      <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-xl shadow-lg">
        <h3 class="text-lg font-semibold mb-2">Saldo</h3>
        <p id="balance" class="text-3xl font-bold">Rp 0</p>
      </div>
    </div>

    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold">Daftar Transaksi</h2>
      <button onclick="showAddModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition">
        <i class="fas fa-plus mr-2"></i>Tambah Transaksi
      </button>
    </div>

    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr class="bg-gray-50">
              <th class="py-3 px-4 text-left">Tanggal</th>
              <th class="py-3 px-4 text-left">Jenis</th>
              <th class="py-3 px-4 text-left">Keterangan</th>
              <th class="py-3 px-4 text-left">Jumlah</th>
              <th class="py-3 px-4 text-left">Kategori</th>
              <th class="py-3 px-4 text-left">Aksi</th>
            </tr>
          </thead>
          <tbody id="finances-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="finance-modal" class="modal hidden">
    <div class="modal-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Tambah Transaksi</h2>
        <button onclick="hideModal('finance-modal')" class="text-gray-500 hover:text-gray-700">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>

      <form id="finance-form" class="space-y-4">
        <input type="hidden" id="finance-id">

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Transaksi</label>
          <select id="finance-type" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            <option value="income">Pemasukan</option>
            <option value="expense">Pengeluaran</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
          <input type="text" id="finance-description" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah</label>
          <input type="number" id="finance-amount" required min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
            <input type="date" id="finance-date" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
            <input type="text" id="finance-category" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          </div>
        </div>

        <div class="flex gap-4">
          <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
            Simpan
          </button>
          <button type="button" onclick="hideModal('finance-modal')" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition">
            Batal
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="/assets/js/firebase-config.js"></script>
  <script src="/assets/js/auth.js"></script>
  <script src="/assets/js/main.js"></script>
  <script src="/assets/js/finances.js"></script>

  <script>
    checkAuth('bendahara');

    async function loadFinances() {
      const summaryResult = await getFinancialSummary();
      if (summaryResult.success) {
        const { totalIncome, totalExpense, balance } = summaryResult.data;
        document.getElementById('total-income').textContent = formatCurrency(totalIncome);
        document.getElementById('total-expense').textContent = formatCurrency(totalExpense);
        document.getElementById('balance').textContent = formatCurrency(balance);
      }

      const recordsResult = await getFinancialRecords();
      if (recordsResult.success) {
        const tbody = document.getElementById('finances-tbody');
        tbody.innerHTML = recordsResult.data.map(record => `
          <tr class="border-b hover:bg-gray-50">
            <td class="py-3 px-4">${formatDate(record.date)}</td>
            <td class="py-3 px-4">
              <span class="px-2 py-1 text-xs rounded ${record.type === 'income' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                ${record.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}
              </span>
            </td>
            <td class="py-3 px-4">${record.description}</td>
            <td class="py-3 px-4 font-semibold ${record.type === 'income' ? 'text-green-600' : 'text-red-600'}">
              ${formatCurrency(record.amount)}
            </td>
            <td class="py-3 px-4">${record.category || '-'}</td>
            <td class="py-3 px-4">
              <button onclick="editFinancialRecord('${record.id}')" class="text-blue-600 hover:text-blue-800 mr-2">
                <i class="fas fa-edit"></i>
              </button>
              <button onclick="deleteFinancialRecordConfirm('${record.id}')" class="text-red-600 hover:text-red-800">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `).join('');
      }
    }

    function showAddModal() {
      document.getElementById('finance-form').reset();
      document.getElementById('finance-id').value = '';
      document.getElementById('finance-date').valueAsDate = new Date();
      showModal('finance-modal');
    }

    function deleteFinancialRecordConfirm(id) {
      if (confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) {
        deleteFinancialRecord(id).then(result => {
          if (result.success) {
            showToast('Transaksi berhasil dihapus', 'success');
            loadFinances();
          } else {
            showToast('Gagal menghapus transaksi', 'error');
          }
        });
      }
    }

    document.getElementById('finance-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = document.getElementById('finance-id').value;
      const type = document.getElementById('finance-type').value;
      const description = document.getElementById('finance-description').value;
      const amount = parseInt(document.getElementById('finance-amount').value);
      const date = new Date(document.getElementById('finance-date').value);
      const category = document.getElementById('finance-category').value;

      const recordData = { type, description, amount, date, category };

      let result;
      if (id) {
        result = await updateFinancialRecord(id, recordData);
      } else {
        result = await createFinancialRecord(recordData);
      }

      if (result.success) {
        showToast('Transaksi berhasil disimpan', 'success');
        hideModal('finance-modal');
        loadFinances();
      } else {
        showToast('Gagal menyimpan transaksi', 'error');
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      loadFinances();
      document.getElementById('finance-date').valueAsDate = new Date();
    });
  </script>
</body>
</html>
